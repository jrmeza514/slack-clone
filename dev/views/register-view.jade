link(rel="import", href="../bower_components/polymer/polymer.html")
dom-module(id="register-view")
	template
		div
			form(action="http://localhost:8080/api/auth/register", method="post", enctype="application/x-www-form-urlencoded", id='registration-form')
				input(placeholder="Username", name="userId")
				input(type="password", placeholder="Password", name="password")
				input(type="password", placeholder="Verify Password", name="password_verify")
				input(type="email", placeholder="Email", name="email")
				input(type="submit", value="submit")
	script.
		Polymer({
			is:'register-view',
			attached: function(){
				const regForm = document.getElementById('registration-form');
				regForm.addEventListener('submit', e => {
					e.preventDefault();
					let regPromise = register( regForm );
					regPromise.then( user => {
						console.log( user );
					})
					.catch((err) => {
						console.log( err );
					});
				});
			}
		});
		
		function register( form ){
			return new Promise(( resolve, reject ) => {
				const data = new FormData( form );
				const REG_API_URL = 'http://localhost:8080/api/auth/register';
				const METHOD = 'POST';
				let params = encodeFormData( data );
				fetch( REG_API_URL , {
					method: METHOD,
					body: params,
					headers: {
						"Content-type": "application/x-www-form-urlencoded"
					}
				})
				.then( res => {
					return res.json();
				})
				.then( data => {
					console.log( data );
				})
				.catch((err) => {
					console.error(err);
				});
			});
		}
		
		function encodeFormData( formData ) {
			let keys = formData.keys();
			let urldata = '';
			let n = keys.next();
			while ( !n.done ) {
				let key = n.value;
				if ( urldata ) urldata += '&';
				urldata += `${key}=${encodeURIComponent(formData.get(key))}`;
				n = keys.next();
			}
			return urldata;
		}
